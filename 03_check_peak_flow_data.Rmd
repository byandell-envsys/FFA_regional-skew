---
title: "Peak flow locs for Northwestern Great Plains and High Plains ecoregion"
author: "CJ Tinant"
date: "`r Sys.Date()`"
output: html_document
---

<!--
PURPOSE: Prepare peak flow data for analysis 

METHODS:
1. Check peak flow record flags.

2. Omit records with:
* "3" -- "Discharge affected by Dam Failure",
* "5" -- "Discharge affected to unknown degree by Regulation or Diversion",
* "6" -- "Discharge affected by Regulation or Diversion",
* "C" -- "All or part of the record affected by Urbanization, Mining, Agricultural changes, Channelization, or other",

3. Check records with:
* "4" -- "Discharge less than indicated value which is Minimum Recordable Discharge at this site",
* "A" -- "Year of occurrence is unknown or not exact",
* "Bd" -- "Day of occurrence is unknown or not exact",
* "Bm" -- "Month of occurrence is unknown or not exact",
* "O", "Opportunistic value not from systematic data collection",

4. Keep records with
* "1" -- "Discharge is a Maximum Daily Average",
* "2" -- "Discharge is an Estimate",
* "7" -- "Discharge is an Historic Peak",
* "8" -- "Discharge actually greater than indicated value",
* "9" -- "Discharge due to Snowmelt, Hurricane, Ice-Jam or Debris Dam breakup",
* "F", "Peak supplied by another agency",
* "R", "Revised"

RESULTS
sites_peak -- 

DATA DICTIONARY
omit_flag               -- records omitted (n = 9,939)
omit_flag_affected      -- records omitted because of affected discharge (n = 473)
omit_flag_dam_fail      -- records omitted because of dam failure (n = 1)
omit_flag_regulated     -- records omitted discharge regulation (n = 5,898)
omit_flag_unkn_degr_reg -- records omitted unkn degr of regulation

peak_data_orig -- peak flow records for sites with gt 20 yrs data (n = 24,480)
peak_data      -- peak flow records for unreg sites (n = 14,922)

peak_flag_summ -- USGS codes for data flags
peak_flags     -- peak flow records with flags

sites_peak        -- sites in study area with gt 20 yrs data (n = 518)
sites_peak_unreg  -- unregulated sites in study area w gt 20 yrs data (n = 331)

-->

```{r 00_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# library
library(tidyverse)        # Load the 'Tidyverse' packages: ggplot2, dplyr, 
                          #   tidyr, readr, purrr, tibble, stringr, and forcats
library(dataRetrieval)    # Retrieval functions for USGS and EPA hydrology and
                          #   water quality data
library(sf)               # Simple features for R
library(Lmoments)         # L-moments and trimmed L-moments from the data
library(lmom)

```

```{r 01_import_peak-flow_pf-data_pf-station-metadata}

# get peakflow metadata
sites_peak_orig <- read_csv("data/sites_peak.csv")

# get peakflow data
peak_data_orig <- read_csv("data/data_peak.csv")

```

```{r 02_make_pf-flag-descriptions}

peak_flag_desc <- tribble(
  ~peak_cd, ~peak_cd_descr,
  "1", "Discharge is a Maximum Daily Average",
  "2", "Discharge is an Estimate",
  "3", "Discharge affected by Dam Failure",
  "4", "Discharge less than indicated value which is Minimum Recordable Discharge at this site",
  "5", "Discharge affected to unknown degree by Regulation or Diversion",
  "6", "Discharge affected by Regulation or Diversion",
  "7", "Discharge is an Historic Peak",
  "8", "Discharge actually greater than indicated value",
  "9", "Discharge due to Snowmelt, Hurricane, Ice-Jam or Debris Dam breakup",
  "A", "Year of occurrence is unknown or not exact",
  "Bd", "Day of occurrence is unknown or not exact",
  "Bm", "Month of occurrence is unknown or not exact",
  "C", "All or part of the record affected by Urbanization, Mining, Agricultural changes, Channelization, or other",
  "F", "Peak supplied by another agency",
  "O", "Opportunistic value not from systematic data collection",
  "R", "Revised"
  )

```

```{r 03_pf_data_check_flags}
# tidy data flags
#   peak_flags    
peak_flags <- peak_data_orig %>%
  select(-peak_va) %>%
  distinct() %>%
  filter(!is.na(peak_cd)) %>%
  separate(peak_cd, into = c("scratch_1",
                             "scratch_2",
                             "scratch_3",
                             "scratch_4",
                             "scratch_5"
                             ),
           sep = ",",
           remove = FALSE,
           extra = "merge") %>%
  pivot_longer(cols = starts_with("scratch")) %>%
  select(-c(peak_cd, name)) %>%
  rename(peak_cd = value) %>%
  distinct() %>%
  filter(!is.na(peak_cd)) %>%
  select(site_no, peak_dt, peak_cd)
```

```{r 04_pf_data_omit_records}

# pull records with dam fail, regulation, or discharge otherwise affected
omit_flag_dam_fail <- peak_data_orig %>%
  filter(peak_cd == "3")

omit_flag_unkn_degr_reg <- peak_data_orig %>%
  filter(peak_cd == "5")

omit_flag_regulated <- peak_data_orig %>%
  filter(peak_cd == "6")

omit_flag_affected <- peak_data_orig %>%
  filter(peak_cd == "C")

# remove omitted records from working df
omit_flag <- bind_rows(omit_flag_dam_fail,
                       omit_flag_unkn_degr_reg,
                       omit_flag_regulated,
                       omit_flag_affected
                       )

# clean up Global Environment
rm(list = ls(pattern = "omit_flag_"))

```

```{r 05_pf_data_drop_sites}

# remove omitted data from orig data
scratch <- anti_join(peak_data_orig, omit_flag)

# subset regulated and unregulated sites
sites_unreg_all <- scratch %>%
  group_by(site_no) %>%
  summarise(pk_count = n())

sites_unreg_lt_20 <- sites_unreg_all %>%
  filter(pk_count < 20)

sites_peak_unreg <- anti_join(sites_unreg_all, sites_unreg_lt_20,
                         by = join_by(site_no))

# update working df for only unregulated sites
peak_data <- peak_data_orig %>%
  filter(site_no %in% sites_peak_unreg$site_no)

rm(scratch)
rm(omit_flag)
rm(list = ls(pattern = "_flag"))
rm(list = ls(pattern = "sites_unreg"))

```

# NEXT STEP -- VISUALIZE THE ORIGINAL AND REMOVED SITES

```{r 06_pf_data_check_records}

check_flag_disch_lt_recorded <- peak_data_orig %>%
  filter(peak_cd == "4")

check_flag_unkn_yr <- peak_data_orig %>%
  filter(peak_cd == "A")

check_flag_unkn_mo <- peak_data_orig %>%
  filter(peak_cd == "Bm")

check_flag_unkn_dy <- peak_data_orig %>%
  filter(peak_cd == "Bd")

check_flag_opportunistic <- peak_data_orig %>%
  filter(peak_cd == "O")

```

```{r 07_pf_data_check_dates}

# separate missing dates for recheck

# get missing peak flow dates
peak_date_miss <- peak_data_orig %>%
  filter(is.na(peak_dt))

peak_data <- anti_join(peak_data_orig, peak_date_miss)

```


# revise below
```{r 04_pf_data_get_peak_months}

peak_months <- peak_data %>%
  mutate(peak_mon = month(peak_dt)
         ) %>%
  select(c(peak_dt, site_no, peak_mon))

peak_mon_ck <- peak_months %>%
  filter(is.na(peak_mon))



  group_by(site_no) %>%
  summarise(mon_mean = mean(peak_mon),
            mon_median = median(peak_mon),
            mon_sd = sd(peak_mon)
             ) %>%
  ungroup()

```

```{r 02_munge_pf_data_drop_vars, eval=FALSE}

# drop not needed vars

peak_data <- peak_data %>%
  select(-c(
    agency_cd,
    peak_tm,
    gage_ht,
    gage_ht_cd,
    ag_tm,
    ag_gage_ht,
    ag_gage_ht_cd,
    peak_dateTime,
    ag_dateTime,
    ag_dt,
    year_last_pk
  ))

```

```{r 04_munge_pf_metadata}

# Identify missing data
sites_gt_20_missing_data <- sites_peak %>%
  summarize(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(cols = everything())

```



```{r fix_this_how_to_get_Lmoments}

moments <- peak_data %>%
  group_by(site_no) %>%
  samlmu(peak_data$peak_va, 4)

  summarise(moments = Lmoments(peak_data$peak_va))


```


<!--
# Ecoregion hierarchy
Northwestern Great Plains and High Plains region of the SOUTH CENTRAL SEMI-ARID PRAIRIES of the GREAT PLAINS ecoregion

## Next steps
create an inline unzip
unzip /path/to/your/file.zip -d /path/to/destination/folder

-- need to add ecoreg when joining


* sync personal and group Zotero library for FFA
https://guides.library.oregonstate.edu/c.php?g=359201&p=2426111
https://www.zotero.org/groups/5473862/olc_flood-frequency


## Helpful references:
GIT issues--
[GIT issues](https://dangitgit.com/)

Spatial data issues--
[Intro to spatial data in R](https://www.r4wrds.com/intro/m_intro_mapmaking)
[Overview of Coordinate Reference Systems (CRS) in R](https://www.nceas.ucsb.edu/sites/default/files/2020-04/OverviewCoordinateReferenceSystems.pdf)
[Geocomputation with R](https://r.geocompx.org/)

References:
[dataRetrieval tutorial](https://waterdata.usgs.gov/blog/dataretrieval/)

[USGS watermapper](https://maps.waterdata.usgs.gov/mapper/index.html)
-->






