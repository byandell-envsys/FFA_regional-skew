---
title: "Get peak flow data for Northwestern Great Plains ecoregion gages"
author: "CJ Tinant"
date: "`r Sys.Date()`"
output: html_document
---

<!--

Purpose: get data to identify peak-flow sites in the Northern Great Plains and High Plains level-3 ecoregions with greater than 20-years of record

Helpful websites:
[USEPA level-3 and level-4 ecoregions](https://www.epa.gov/eco-research/level-iii-and-iv-ecoregions-continental-united-states)
[GIT issues](https://dangitgit.com/)
[GIT ignore](https://carpentries-incubator.github.io/git-Rstudio-course/02-ignore/index.html)

--> 

```{r 00_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# library
library(tidyverse)        # Load the 'Tidyverse' packages: ggplot2, dplyr, 
                          #   tidyr, readr, purrr, tibble, stringr, and forcats
library(dataRetrieval)    # Retrieval functions for USGS and EPA hydrology and
                          #   water quality data
library(sf)               # Simple features for R
library(here)             # A simpler way to find files

```

```{r 01_find_sites_north-GP}
# watermapper for visualization
# https://maps.waterdata.usgs.gov/mapper/index.html

#  west  south  east  north
# -111.5, 42.0, -99.5, 48.5

# get a list of sites for the Northwestern Great Plains ecoregion bounding box
sites_nw <- whatNWISsites(                       #  west  south  east  north
  bBox = c(-111.5, 45.0, -105.5, 48.5)           # -111.5, 45.0, -105.5, 48.5
  )

sites_sw <- whatNWISsites(                       #  west  south  east  north
  bBox = c(-111.5, 42.0, -105.5, 45.0)           # -111.5, 42.0, -105.5, 45.0
  )

sites_ne <- whatNWISsites(                       #  west  south  east  north
  bBox = c(-105.5, 45.0, -99.5, 48.5)            # -105.5, 45.0, -99.5, 48.5
  )

sites_se <- whatNWISsites(                       #  west  south  east  north
  bBox = c(-105.5, 42.0, -99.5, 45.0)            # -105.5, 42.0, -99.5, 45.0
  )

# bind rows -- filter stream gages
sites_ngp <- bind_rows(sites_nw, sites_sw, sites_ne, sites_se) %>%
  filter(site_tp_cd == "ST")

# get a list of all peak flow data 
peak_ngp <-  whatNWISdata(
  siteNumber = sites_ngp$site_no,
  service = "pk"
  )

# get a list of peak flow data greater than 20-years
peak_ngp_gt20 <- peak_ngp %>%
  filter(count_nu > 20)

# clean up Global Environment
rm(list = ls(pattern = "sites"))

```

```{r 02_find_sites_high-plains}

# need to update the areas

# watermapper for visualization
# https://maps.waterdata.usgs.gov/mapper/index.html

#  west  south  east  north
# -105.6, 31.0, -100, 42.0

# get a list of sites for the High Plains ecoregion bounding box
sites_nw <- whatNWISsites(                       #  west  south  east  north
  bBox = c(-105.6, 37.5, -102.8, 42.0)           # -111.5, 45.0, -105.5, 48.5
  )

sites_sw <- whatNWISsites(                       #  west  south  east  north
  bBox = c(-105.6, 31.0, -102.8, 37.5)           # -111.5, 42.0, -105.5, 45.0
  )

sites_ne <- whatNWISsites(                       #  west  south  east  north
  bBox = c(-105.6, 37.5, -100, 42.0)            # -105.5, 45.0, -99.5, 48.5
  )

sites_se <- whatNWISsites(                       #  west  south  east  north
  bBox = c(-105.6, 31.0, -100, 37.5)            # -105.5, 42.0, -99.5, 45.0
  )

sites_st <- bind_rows(sites_nw, sites_sw, sites_ne, sites_se) 

# filter stream gages
sites_st <- sites_st %>%
  filter(site_tp_cd == "ST")

sites <- sites_st %>%
  select(site_no) 
  
# get a list of peak flow data greater than 20-years
sites_peak <-  whatNWISdata(
  siteNumber = sites$site_no,
  service = "pk"
  )
  
sites_peak_gt_20 <- sites_peak %>%
  filter(count_nu > 20)

```

```{r 03_export_peak_sites}

write_csv(sites_peak, "data/sites_peak_all.csv")
write_csv(sites_peak_gt_20, "data/sites_peak_gt_20.csv")

```

```{r 04_dl_shapefiles}

# download level-3 and level-4 ecoregions shapefiles by calling the
# download.file() function, passing in the URL and file name/location as arguments

# level-3 ecoregion download--
#  URL of the file to download 
url <- "https://gaftp.epa.gov/EPADataCommons/ORD/Ecoregions/us/us_eco_l3.zip"

# file name and location where you want to save the file on your computer
file_path <- "data_spatial"
file_name <- "us_eco_l3.zip"

download.file(url, paste(file_path, file_name, sep = ""))

# level-4 ecoregion download
url <- "https://gaftp.epa.gov/EPADataCommons/ORD/Ecoregions/us/us_eco_l4.zip"
file_name <- "us_eco_l4.zip"

download.file(url, paste(file_path, file_name, sep = ""))

```

