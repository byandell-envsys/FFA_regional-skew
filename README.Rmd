---
title: "Regional Skew Estimation Project"
output: 
  github_document:
    toc: true
    toc_depth: 2
---

# Overview

This project supports the development of regional skew estimation for flood frequency analysis (FFA) across the Great Plains and adjacent regions. The workflow automates downloading, cleaning, and organizing USGS and PRISM data for unregulated stream gages with sufficient record length.

The project follows a reproducible, modular workflow using R and the `{tidyverse}`.

# Folder Structure

```         
FFA_regional-skew/
├── data/
│   ├── raw/           # Original downloaded data (PRISM, USGS)
       ├── prism/ 
│   ├── clean/         # Cleaned data ready for modeling
│   ├── meta/          # Metadata for all datasets
│   └── spatial/       # Spatial data for ecoregions (EPA)
├── functions/         # Reusable R functions
├── notebooks/         # Rmd files from prior EDA
├── references_pdfs/   # A subset of project-related references
├── scripts/           # Numbered R scripts for each workflow milestone
├── README.Rmd         # This file (source)
├── README.md          # Rendered output
└── .gitignore         # Prevents sensitive/local files from being pushed
```

# Workflow Overview

| Milestone | Script | Purpose | Output(s) |
|------------------|------------------|--------------------|------------------|
| 01 | 01_get_spatial_data.R | Download & prepare spatial data (bounding box, HUC, eco). | `/data/raw/spatial/` shapefiles |
| 02 | 02_get_gage_data.R | Query USGS NWIS peak flow data for all sites in study area. | `/data/raw/sites_all_peak_in_bb.csv` |
| 03 | 03_filter_unregulated_gage_data.R | Filter to unregulated sites with ≥20 years of data. | `/data/clean/data_pk_unreg_gt_20.csv` |
| 04 | 04_find_clean_export_site_summaries.R | Query site metadata from NWIS and WQP, clean, export. | `/data/clean/site_summary_NWIS_clean.csv` |
| 05 | 05_update_problem_sites.R | Remove sites with missing/zero peaks or \<20 observations. | Updated site and data files |
| 06 | 06_calculate_station_skew.R | Calculate log-Pearson III station skew for each site. | `/data/clean/station_skew.csv` |
| 07 | 07_download_climate_covariates.R | Download & extract PRISM climate normals to gage sites. | `/data/clean/data_covariates_climate.csv` |
| 08 | 08_download_terrain_covariates.R | Download & extract elevation & slope covariates. | `/data/clean/data_covariates_terrain.csv` |
| 09 | 09_join_covariates_for_modeling.R | Integrate covariate datasets with calculated station skew values for initial regional skew modeling. | `/data/clean/data_covariates_modeling.csv` `/data/meta/data_covariates_modeling.csv` results/figures/	Exploratory plots: pairplots, heatmaps, and maps of terrain outliers

# Data Notes

## PRISM Climate Normals

-   Source: <https://prism.oregonstate.edu/normals/>
-   Resolution: 4km gridded .bil rasters
-   Time period: 1991-2020
-   Variables:
    -   Monthly & Annual Total Precipitation (mm)
    -   Monthly & Annual Mean Temperature (°C)

## USGS Peak Flow Data

-   Queried via `{dataRetrieval}` package
-   Includes:
    -   Annual peak flows
    -   Site metadata
    -   Regulation flags
    -   Record length

# Reproducibility Notes

## Note on Outlier Removal: Slope Outlier Site

During Milestone 09, an exploratory analysis of terrain covariates identified a single gage site with an unusually high slope value relative to the surrounding landscape of the Great Plains Level I Ecoregion, where terrain is generally low relief and slope values are typically small.

Specifically:
- Site Number: `06192500`
- Slope: 25.48 degrees (substantially higher than the regional norm)
- Location: Perched at the abrupt edge of a significant elevation transition zone (e.g., mountain front)

The slope value derived from a coarse-resolution elevation raster (z = 8, ~1 km), near a sharp elevation break.Slope estimation in these transitional zones is highly sensitive to raster resolution and gage placement relative to topography.

Given the magnitude of this outlier, and its likely geologic distinctiveness compared to the majority of sites in this study area, this site was removed from subsequent exploratory analysis and modeling datasets.

The site was retained in the raw terrain covariate dataset (`data/clean/data_covariates_terrain.csv`) for transparency, but excluded from the final modeling dataset (`data/clean/data_covariates_modeling.csv`).

Rationale for removal:
- Prevent undue influence of a single geologically distinct site on model fit.
- Focus on generalizing skew relationships for typical Great Plains terrain settings.
- Outlier removal was fully documented in:
    - `09_join_covariates_for_modeling.R` (script)
    - `data/meta/data_covariates_modeling.csv` (metadata)

A map of the outlier location is provided in:

results/figures/slope_outlier.png

## Coordinate Reference Systems (CRS)

| Dataset       | CRS   | EPSG | Notes                            |
|---------------|-------|------|----------------------------------|
| PRISM         | NAD83 | 4269 | Native raster CRS                |
| USGS Sites    | WGS84 | 4326 | Transformed to NAD83 later       |
| Final Outputs | NAD83 | 4269 | All data harmonized for modeling |

# Dependencies

``` r
library(tidyverse)
library(here)
library(sf)
library(terra)
library(prism)
library(janitor)
library(dataRetrieval)
library(glue)
```

# Citation

> Daly, C., et al. (2008). Physiographically-sensitive mapping of temperature and precipitation across the conterminous United States. *International Journal of Climatology*, 28(15), 2031-2064.

> USGS NWIS Data retrieved using `{dataRetrieval}` R package.
